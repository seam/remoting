<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<title>Seam Remoting - Model Example</title>
	<link href="style.css" rel="stylesheet" type="text/css"/>
	<link href="tree.css" rel="stylesheet" type="text/css"/>
</head>

<body onload="loadPeople()">

  <h1>Seam Remoting - Model Example</h1>
  
  <script type="text/javascript" src="seam/resource/remoting/resource/remote.js?compress=true"></script>
  <script type="text/javascript" src="seam/resource/remoting/interface.js?personSearch"></script>
  
  <script type="text/javascript">    
    //<![CDATA[

    // Turn on debug logging so we can see the request and response packets    
    Seam.debug = true;
        
    var model = null;        
    
    function clearElement(e) {
      while (e.hasChildNodes()) {
        e.removeChild(e.firstChild);
      }      
    }
    
    function createLinkRow(text, onclick) {
      var link = document.createElement("a");
      link.href = "#";
      if (onclick) link.setAttribute("onclick", onclick);
      link.appendChild(document.createTextNode(text));
      var div = document.createElement("div");
      div.appendChild(link);
      return div;      
    }
    
    function loadPeople() {
      var personList = document.getElementById("personList");
      
      var callback = function(people) {
        for (var i = 0; i < people.length; i++) {
          personList.appendChild(createLinkRow(
            people[i].firstName + " " + people[i].lastName, 
            "editPerson(" + people[i].personId + ")"));
        } 
      };
      
      clearElement(personList);      
      Seam.createBean("personSearch").listPeople(callback);
    }
    
    // A helper function that returns the value of an element
    function getElementValue(elementName) {
      var value = document.getElementById(elementName).value;
      return (value.trim().length > 0) ? value : null; 
    }    
    
    function editPerson(personId) {
      var action = new Seam.Action()
        .setBeanType("org.jboss.seam.remoting.examples.model.PersonAction")
        .setMethod("editPerson")
        .addParam(personId);
      
      model = new Seam.Model();
      model.addBeanProperty("person", "org.jboss.seam.remoting.examples.model.PersonAction", "person");
      model.fetch(action, fetchCallback);
    }
      
    function fetchCallback(model) {           
      var person = model.getValue("person");
      document.getElementById("firstName").value = person.getFirstName();
      document.getElementById("lastName").value = person.getLastName();
      document.getElementById("dob").value = person.getDateOfBirth();
      
      var addressDiv = document.getElementById("addresses");
      clearElement(addressDiv);      
      addressDiv.appendChild(createLinkRow("Load addresses", "loadAddresses()"));
      
      document.getElementById("applyChanges").disabled = false;
    }
    
    function loadAddresses() {
      model.expand(model.getValue("person"), "addresses", loadAddressesCallback); 
    }
    
    function loadAddressesCallback() {
      var addressDiv = document.getElementById("addresses");
      clearElement(addressDiv); 
      
      var addresses = model.getValue("person").getAddresses();
      if (addresses.length > 0) {
        var header = document.createElement("div");
        header.className = "sectionHeader";
        header.appendChild(document.createTextNode("Addresses"));        
        addressDiv.appendChild(header);
        
        for (var i = 0; i < addresses.length; i++) {
          addressDiv.appendChild(createAddressEditor(addresses[i]));           
        }
      } else {
        addressDiv.appendChild(document.createTextNode("No addresses found")); 
      }
    }
    
    function createLabel(text) {
      var lbl = document.createElement("label");
      lbl.appendChild(document.createTextNode(text));
      return lbl; 
    }
    
    function createBoundInput(obj, propertyName, className) {
      var input = document.createElement("input"); 
      input.type = "text";
      input.value = obj[propertyName];
      input.onchange = function(event) { obj[propertyName] = event.target.value;}
      if (className) input.className = className;
      return input;
    }
    
    function apply() {      
      document.getElementById("applyChanges").disabled = true;

      // TODO apply person changes here
      
      model.applyUpdates(); 
    }
    
    function createAddressEditor(address) {
      var addressDiv = document.createElement("div");
      addressDiv.className = "addressContainer";
      var row1 = document.createElement("div");
      var row2 = document.createElement("div");
      var row3 = document.createElement("div");
      addressDiv.appendChild(row1);
      addressDiv.appendChild(row2);
      addressDiv.appendChild(row3);
      
      row1.appendChild(createLabel("Street No"));
      row1.appendChild(createBoundInput(address, "streetNo", "streetNo"));
      row1.appendChild(createLabel("Street Name"));
      row1.appendChild(createBoundInput(address, "streetName"));
      
      row2.appendChild(createLabel("Suburb"));
      row2.appendChild(createBoundInput(address, "suburb"));
      row2.appendChild(createLabel("Postcode/Zip"));
      row2.appendChild(createBoundInput(address, "postCode", "postCode"));
      
      row3.appendChild(createLabel("Country"));
      row3.appendChild(createBoundInput(address, "country"));
     
      return addressDiv; 
    }
        
    // ]]>
  </script>   
  
  <div class="listContainer">
    <div class="sectionHeader">People</div>
    
    <div id="personList"></div>
    
    <div>
      <a href="#" onclick="javascript:alert('new person')">Create new person</a>
    </div>
  </div>
  
  <div class="personDetail">
    <div class="sectionHeader">Details</div>
    
    <div class="formRow">
      <label for="firstName">First name</label>
      <input type="text" id="firstName"/>
    </div>
    
    <div class="formRow">
      <label for="lastName">Last name</label>
      <input type="text" id="lastName"/>
    </div>
      
    <div class="formRow">
      <label for="dob">Date of birth</label>
      <input type="text" id="dob"/>
    </div>
    
    <div id="addresses">
      
    </div>
    
    <div class="personAction">
      <button id="applyChanges" onclick="apply()" disabled="true">Apply changes</button>
    </div>
    
    <br class="clear"/>
  </div>
    
</body>
</html>

